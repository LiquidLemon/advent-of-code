INPUT = DATA.read

max_x = nil
max_y = -1

ROCKS = INPUT.lines(chomp: true).each.with_index.flat_map { |line, y|
  max_x ||= line.length - 1
  max_y += 1

  line.chars.each.with_index.filter { |c, _|
    c != "."
  }.map { |c, x|
    [[x, y], c]
  }
}.to_h

x_range = 0..max_x
y_range = 0..max_y

dirs = [
  [0, -1],
  [-1, 0],
  [0, 1],
  [1, 0],
]

loads = []
seen_loads = Hash.new

state = ROCKS.dup
max_cycle = 1_000_000_000 - 1

get_load = ->(state) {
  state.sum { |(x, y), c|
    c == "#" ? 0 : max_y - y + 1
  }
}

catch :break do
  (0..max_cycle).each { |i|
    (0..3).each { |subcycle|
      dir = dirs[subcycle]

      loop do
        moved_rocks = 0
        new_state = Hash.new
        dx, dy = dir

        state.each { |pos, c|
          if c == "#"
            new_state[pos] = "#"
          else
            x, y = pos
            new_x = x + dx
            new_y = y + dy
            new_pos = [new_x, new_y]

            if x_range.include?(new_x) && y_range.include?(new_y) && !state.include?(new_pos)
              new_state[new_pos] = "O"
              moved_rocks += 1
            else
              new_state[pos] = "O"
            end
          end
        }


        state = new_state
        break if moved_rocks == 0
      end

      if i == 0 && subcycle == 0
        p get_load.(state)
      end
    }

    curr_load = get_load.(state)
    loads[i] = curr_load
    seen_load = seen_loads[state]

    if !seen_load.nil?
      cycle_length = i - seen_load
      load_i = seen_load + ((max_cycle - i) % cycle_length)
      p loads[load_i]

      throw :break
    end

    seen_loads[state] = i
  }
end


__END__
#.....OO..O#.O.#O......#...#...#.O......OOO.....O#...OO##...#..#O..O...........O..#O....O......O..#.
#....O#..OO#..O.#O#O......O..#..#.O..#.....###....#.O.....#O#.##..##..............O..OO.#O.##OO.O.O.
OO..#.O.O....O..#..##.O..#.O..#O..#..#..#..O.O..#...O#.OO.O.#.....#..#.O..OO.#......#....#.O..#.#.#O
....#..#.#.O...O.........#...O...##.....O......#O#O.#O.............O..#O.....O.O.O..O#......#.O.#..O
#...O..#..#..#..OO......#.....O.OO...#...OO.O......#O.....OOOOO.##......#.#....OOO#...#.......O.....
.O.O...O.#.....O..##......##O#....O.##.#OO#...#OO..O..##...#....#..O.O.##......#..O.O#...........#.#
....#....#...OO....#..#.O...O...O.OO#O.OO..O...OO.O....#OO#.#....O....O..#...#.#.##.O...O.O..O..##..
...OOO..#..##..O..O.#...#O......OOO....#.#.OO.#.#..#.##O...O.O....##OO..............O#.O..##.O#..OO.
##..#.......OOO..O....#.O...O.O......O#..O##.OO###..OO....O......#....##.O.....#O#O...#..O....#.....
#..OOO..#.O##O.......O..O....O...#.....#OO..#.......##.O...#....#.#..O.O.#O.....OOOO##..##O#O....O..
#.O#..O.#..OO.O.#O.OO#O....OO.....#..O...#..........#....OO..O#O.#OO......#....OO...#....#O.O.O.##..
#......#.#.#.##.#O#.O....OO....##.O.#..O..O..O...#O.........#.O#.#..#..#...#....#OO..#OO..#........#
...#..O.O.OOO#O#..OO......OO....#..##.....#O.....#.##.OOO#O#..#.....O....#......O.#.#O.O.O..OO.#....
.#O..OO#O...#...#O..O#.OO....O..##..#..#...........#..OO#O.#..#...OO...O.#..#..O..##......OO....O..O
.O..O#O..#...#O#O#.#......#.#..O...............O..O.O#.O..........##..#.O.....OO#.OO.#....#.####....
O..#.O#..O.O.O...#.#O.#.......O....OO.O.#.O.O....#O##.O.......##O..OO#O...##.##O#...........O#.O###.
.O..#O..#....#..O#O....OO#....O#........#.#.#...#......#..##...O.......#O.#.#O#.O...#O.#.OO.#.......
###O.......#.....O.O..#.#.....O.....#...#.#......#O.O.......##......##......OO.#.O..OO...O#.........
..O..O.OO#..OO#O##....O..OO...O.O..OO....#.O...#O.##..#.O........#....#OO#....#...O...O.##.#.#O#OO##
....#OO.O.....#.OO.#.#.#.#......OO......O...#.#.#....O..O#......#O.O#...O#.......#..O..O..O.##....OO
.OO#OOO.....O.OO...O...#....#OO........OOOOO..O..#...O#..O.....#..O#.#......#O.#..###.O.O..#.O.....#
O##.####O.##.OO..#..........O#.O...........#..O..........O...#.....O......#........O.#O.#O#O.O..O...
...#.OO..##.....##.O.##...O....O.##.....#.O..O.O.....O.....#....O..#.#..O..O....O....#O..#O..O..O...
...O#..OO#O..O...O.....#..#..#.O.O......O#......O.##.OO....O...#....#..O............O...OO#.O..O#.O.
O..O..O.#O....O#.##O..#..#.#.O.....####OO...O.##..O#..OO...OO.#O.......##..#.O.....O..O.#O...O..O..#
........#O..#O..O..#.#.....#..#...O.......O...#..OO.##.....O...O..O.#.....##.......#O.#O.#O...#O.#..
......O...#O#OOO.##.##O..#...O....#O.......OO....#...OO....O...#..O...#O.....OO#O#O##..O..OOO.#..#.O
##O..O.O..O.........#O....OO.##O..O..#OO....O.......O#O#.O..O......#....O...#..O#....#.OO#..#....O.#
..O....#...........#.O.O.O...#.#....#.#.........O.#..O.#.#..O........#O....##..#O...O.O#...O.#...O.O
#....O............#....#..O.O......#....#.#O......#.OOO...#.O..O##...#.#..#...O..O..#..#....O...O...
........#..O#.......#O.O.........O.###..#...O#..O.....OO#O...O...OOO.#..........#.O.OO#...O.........
.#.....##.#.#O###.O...#.O##O.#..#..OO.....#.....#....#...O........#..##O.#...O.....O........O#.O.O..
.O.O##...O..##O...#.........OO#O.#...#O.......O.....O#....O.O.....###...O.#..#....O........OO..O....
#.##OO.O.....OOO.#...O......O....#..OO..#O..##...OO.....#.#...O.O#..#O##...OO..#....O#..#.O.#.#..OO.
.O........OO.##....O.#.#....#...O.O#..O...##....OO.O....O.##O..#.O....#O....O.....#..O..O.#...OOO..#
.OOOO..O#O..##......O##....#OO.#..#...#...OO#.........O.#...#..##..O...O.##.OO##..O.#.......#...#O..
.O##......#...#O..OO.O.O.O.......O.#................OO.......O.OO....O......#..O..#....OO#.OO....O#.
....#OOO...#..O..#..OO..##...##...#...O.O...#.O..OO#O....#.....##OO...O.O....#.OO.O.#.#O..O.O#.#...#
OO...#OO.OO#...#.#....O.#.O...#.....OO..O.....#O..#....O.#.#...............O#..#...###.O.O..#......O
#O#.#.....##.O#....#O....O...O.#.OO#.OOO...OO.....OO...O....#.#O....OO..O..#OO#.O...O..#O.##...#....
.#.#O#...OO.....#.O##.OO.....#O.#O....O#..O#..O...O....O#.O...#O........#..#OO...#...O.O.#O##....O..
.O..#.O#O..O....O...#........O....O........OO..O.#..O..#...O.O.#.O.#.O...O........O..#.#.O#...#...#O
....O..O.##O#..O.....OO.O.......##.#....O.....O.OO....#.#..O....#...#O#O.#.#.O..O.#...##.#.O..O.O...
#..OO.OO.#...O##O#.O.#.OOO..#O.#.........OO.O..##.#..#..............OO#..##OOOO.O.#..#....#...#....O
..O..#.....##.#...OO..O.....OO.....O#.O.##.#...O.#O..#............##....##.....##..#.#.O...O#..OO..O
O.#..O.#.........#...OO....OO....#..#...OOO.O..OO.#...OO.......#.#.O..O..O....O.......#O..#O..O..O..
#.O#...OO......#..OO#.....#..O....O#....#O...O....#...O...#.O.O..O.O..#O...O.O...OO.#O..#.O.......O#
#O........##..O...........O#.........#.O.......O...##..OOO..#...###O....#..#.#.#OO#...#O....O.O...O.
#......OO.........O......OO..#..OOO.#......#...O....#.O.#.....OO.#...O..O..........###.O...O......#O
####O..OO#....O#...#.O.......O.#...O.....O##....O.O#........#.....#O.#......O.#O....O.#.OO.O.O.#OO.#
..#.....#.....O...#..O......##.###...#..O...OO#O...O.#..OO...O#...#.....O..#....#O..OO.O#.....#...##
......O#O...O..O...#..O..O.O..#OO.O.#...O##..OOO.#.#.....O....##....#O...O.....OOO..#O.O..O#.OO.O#.#
.....O.....O.OO##...OO#....###..#..OO.#O.#.#..#.....#.....O......OO.#.#OO...##......#..O##.#..O#O...
...#O..#...O...O.O...#....O.#...O..O.O.......#.#O...O.O...O#.....#.O.#.......OO.#..O..O#.....O......
......#.O#.............O...O..O#O...O#.O.#..O..O.O#....#.....O...#...#O.........##...OOO.OO.#.#....O
..O..#O...##.O.O......O##...####.#...#..O#....#...O.O.OO........#...O.#.#........#...O......#....O.O
..O..#O.OO...O..#...#O....O.....#O......#OO.....#...#..#....O..#..##O..O..##...........O.O##...####.
#.OO.O........O.....#O....O..#..##.##.O.....#..........#OO.O.O#O#.....#.O#..O...#O##.....#.#OO......
#.....#....O##..O..OO..O...#..O.##.......#..O..O....#.OO..#..#...O..#..O.#.....O.O..#O#.....#.......
..O...O..O..#O#...........O.....O....OO.....O..OO...###O##..#.O..O..O..O.#.#OOO#O.O......#.O..#.#...
...O#O.O.#..#..........#..OO.###..#O##..O#..OOO....O.#.....##.O##..#...OO...#O....#....OO.O.#.#.#...
.O...#..O#O.O.OO....OOO....O#..OO.#O...O.O..#......O.O...##..#..#O.O.#OO...O.O##...........O#O...O..
..#..#..##...OO#.....O#O.O#..O...O.##O.##...OOO.O.#O#O..O....O#....O..#...#.O##.....#.O.OOO..#.....#
.OO....##O..O#O.O..#.#....OO..O.#.......OOO#.O.......#O.O.O.O.#...O....O.O...##O...O..#OO#.....#...O
.......O.O.O#.OO.#.#OO...#.O#..#...O...#...#.#.....O.#O..OO........O#OO##..#.O.O.O#.O..OO#..#.O##...
...........O...#..#.OO.....O#.#.#...#O......O..OO..#.#...#.O.O.#.O...O.#.O.O..OO.............#.#O...
.#.O#..O.O.O.OOO.##.......#..O.O..O##...O......OOO.......#O#.O.##..#..O...#..#.O.#.O..O...OO#O#.#...
.........OO....O..#.......O..O.OOOO#O....O...O..O.O..#OOOO.O.OO.O...O.......#..O....#..O####..O...O.
O.O.............#..##O#..O..#..............##.O....#O....OOOO............O.#.#O.O....O.#.......O.O#.
....#O.O.#......#....O.O...#O#O#OO#.O.O.....O...O.#...O.OO#...OO#.OO............#....#..O....##.#...
#.O..O.O.O.O.............#.#...#....O..#OO.#........O.........O....#..#.O.O.#....#....#..#O..O......
.#OO..O..O.O.O#...........#...OO.#.....O.O........O..O.....#.##.OO.O..O..........O...#.O...#..O..#O.
...#O#O#.......#.O..O.O.#....#..#..O.O.O..O#..O##........O.O.#....#.......#..O.O..O.#...O..O...#...#
OO.O...#..O.#...#O#......##.#O....O...O.......O.O.O......#...........O.O.#O#.........O...O#..O#.#O..
O.OO.O.O.O.O..#..OO......OO....OO......OO....#.....O........O.#O.O##.O.O.O.#OO.O....OO..##O#...O....
..O..OOO.O...#....O..O#.O...O..O.O#O..OO...#OO.#....#.#.#OO.....#...O..OO#OOO....O..OO.O.O.O#..#.O##
O....O............#.O...O...O.O.O.......#..O....#O..#..O#O...#........#....O...#O.##O.#.O.##O....O..
.O.O....O..O..O..O..O..O.O.O.#....##...O.O.....O..##.O#.O.O.#.OOO.O........O#OO..OOO.#.#..O.....#O.#
OOOO..#.........O...O.....#O.O..#.O.#......O..OO.......#O.............O...#.#.O..#.#.......#.O......
.....OO.O...OO.#O...O.#.#.O.#.#..O.O.....O.O.##O..#...O.#...##O.O##...#O#...#O..........O#....##.O..
.#..#.....#.O..##O.O...O.#..#.#..###...........O..#.....O#.OOO#..#OO.#.##.O#.....OO..##O.#.O..#O...O
#....O...O...O#..O.O......##O...O....##....##.O#.O.....#..##.O#.O#.#...#O.###...#..OO.#O..O.OO....#.
..O.OO.#....O.#.OO....O......##.OO.....#.......#.#..O.O.O...O.........#O#..O.O....O....#O.O.O....###
.O...#......#OO.#.O#.O.#.O...O....OOO##O#.O##....#.O#..#O#......#.#.........OO....O.#....O.....O....
.#..O.O..#O.#....OO....O.O.#.....OO.O#.O#...##O...O#............#.OO.....O...O....#.#O#...#..#.O#.O.
.#O.......O.O.#...O.......#..O..#O..O.##..O#.O#....O..O....O.O#...O..OO................#.OO..O.O.#O.
.....O.#...O.O.#...#...O.O.O.#......#.O.#.##.........#.#.#O.............#O#.....O.#....O..OO#......#
O....O..#.#...#O#.....O.O...#....O..#.O#....O....##.OO..##.....#.O.O...#O...O##....O#OO#...#O#O#.O..
..O.#..#O.O...#......#...O.O..O...O......OO#...O...#OO.OO.#.O##..OOO....O..#...OO.O...#O#O..#OOO.#..
.##....O.#..O#.#OO..#...O....#O...#..OO................O....O....O#.O.#.OO.O....#...OO.#.O#..#O#...#
.....#....#.OO..#O....#.#.....#..##.....O...#.O..O...............#O##....OO.#OO.OO.....O..O......##.
.##..##O..#......#O..O...OO....O.#.#OO..#.....O....#O.#.#.#..O...#O.#....#O.O.....#.#O.O..........O.
.......O##.O..##..##..O#....O.OOO.OO.#..##O...O#.#......#O.....O..#..#...#...#O..#.#..#..#....#..O..
...#.O..O.#....O....O###....O#...#..#O..O...#.#..O.O.OO...O.##......#..##.OO#O..O.......O#.O...O.O..
....O.O.O..#O...O.................OO.O.......O.OO.O#.OO..#.O.OOO.O.O....O...OOO....OO....OO#.#...O.O
OO.....O.#.##.#O..O.O...#.O.O#...O...O.OO....#..#..........O...##..#.....#.#O...#..O#..###...OO#..#.
....#O.....O..O..#.O##.#...###..O...O.O...O#..#.O.#O..#..O.#..O..#....#...#..O..O.O....#..#.....#...
#O.......#..O.O..#.....O#O..O..O.O..##..#....O.O#.#..#.O.#.OO..O...#O....O....O#O#..#.#O.O.....#...O
.O.###.O..#..#..#.......O.O....#..OO...##..O#O#O#.....O.##O.#..O.O.OO.#.O...OO...OO.O..OO.O..#...O#.
.O#OO.#.....O..#.O#.#O.O......O..###.#...#.......O#...#O.#..#..O.#.#......O.O..#O..#...#O..#O.OOO.#.
